#!/bin/sh

# This is a modified version of Lindent distributed with Linux kernel.
# Licensed under GPLv2. Please see Linux kernel for the complete text.
# Copyright (c) 2017, Pavel Roskin

# GNU indent will misindent function declarations if it doesn't recognize
# the type. List some popular types here. Add sparse annotations that are
# used in function declarations, they too can push indent in the right
# direction.

TYPES="
acct_t
acpi_adr_space_type
acpi_bus_address
acpi_event_status
acpi_event_type
acpi_integer
acpi_io_address
acpi_native_int
acpi_object_type
acpi_owner_id
acpi_physical_address
acpi_size
__addrpair
aio_context_t
apm_eventinfo_t
apm_event_t
arch_spinlock_t
async_cookie_t
atm_backend_t
atm_kptr_t
atomic64_t
atomic_long_t
atomic_t
audio_attributes_t
autofs_packet_expire_direct_t
autofs_packet_expire_indirect_t
autofs_packet_missing_direct_t
autofs_packet_missing_indirect_t
autofs_wqt_t
__be16
__be32
__be64
binder_size_t
binder_uintptr_t
blkcnt_t
blkif_sector_t
blkif_vdev_t
blk_qc_t
blk_status_t
bool
BusTypes_type
byte_t
caddr_t
can_err_mask_t
canid_t
cc_t
ceph_seq_t
ceph_snapid_t
CHAR8
cisdata_t
clientid4
clockid_t
clock_t
codel_tdiff_t
codel_time_t
comp2_t
compat_aio_context_t
compat_caddr_t
compat_clock_t
compat_daddr_t
compat_dev_t
compat_elf_gregset_t
compat_fsid_t
__compat_gid32_t
__compat_gid_t
compat_gid_t
compat_ino_t
compat_int_t
compat_ipc_pid_t
compat_key_t
compat_loff_t
compat_long_t
compat_mode_t
compat_nlink_t
compat_off_t
compat_pid_t
compat_s64
compat_sigset_t
compat_sigset_word
compat_size_t
compat_ssize_t
compat_timer_t
compat_time_t
compat_u32
compat_u64
__compat_uid32_t
__compat_uid_t
compat_uid_t
compat_uint_t
compat_ulong_t
compat_uptr_t
comp_t
cpumap_t
cpumask_t
cpumask_var_t
_cstruct
cycles_t
daddr_t
depot_stack_handle_t
dev_t
dio_id
dlm_lockspace_t
dma_addr_t
dma_cap_mask_t
dma_cookie_t
dmx_output_t
domid_t
drbg_flag_t
DriverVer_type
drm_agp_binding_t
drm_agp_buffer_t
drm_agp_info_t
drm_agp_mode_t
drm_auth_t
drm_block_t
drm_buf_desc_t
drm_buf_free_t
drm_buf_info_t
drm_buf_map_t
drm_buf_pub_t
drm_client_t
drm_clip_rect_t
drm_context_t
drm_control_t
drm_ctx_flags_t
drm_ctx_priv_map_t
drm_ctx_res_t
drm_ctx_t
drm_dma_flags_t
drm_dma_t
drm_drawable_info_t
drm_drawable_t
drm_draw_t
drm_handle_t
drm_hw_lock_t
drm_irq_busid_t
drm_list_t
drm_local_map_t
drm_lock_flags_t
drm_lock_t
drm_magic_t
drm_map_flags_t
drm_map_t
drm_map_type_t
drm_sarea_drawable_t
drm_sarea_frame_t
drm_sarea_t
drm_savage_cmd_header_t
drm_scatter_gather_t
drm_set_version_t
drm_stats_t
drm_stat_type_t
drm_tex_region_t
drm_unique_t
drm_update_draw_t
drm_vblank_seq_type_t
drm_version_t
drm_wait_vblank_t
efi_bool_t
efi_guid_t
efi_handle_t
efi_physical_addr_t
efi_status_t
Elf32_Addr
Elf32_Half
Elf32_Off
Elf32_Sword
Elf32_Word
Elf64_Addr
Elf64_Half
Elf64_Off
Elf64_SHalf
Elf64_Sword
Elf64_Sxword
Elf64_Word
Elf64_Xword
elf_fpregset_t
elf_fpxregset_t
elf_greg_t
emu10k1_fx8010_code_t
emu10k1_fx8010_control_gpr_t
emu10k1_fx8010_info_t
emu10k1_fx8010_pcm_t
emu10k1_fx8010_tram_t
erase_info_t
errseq_t
event_word_t
evtchn_port_t
evtchn_reset_t
f2fs_hash_t
fd_set
fdt16_t
fdt32_t
fdt64_t
fe_bandwidth_t
fe_caps_t
fe_code_rate_t
fe_delivery_system_t
fe_guard_interval_t
fe_hierarchy_t
fe_modulation_t
fe_pilot_t
fe_rolloff_t
fe_sec_mini_cmd_t
fe_sec_tone_mode_t
fe_sec_voltage_t
fe_spectral_inversion_t
fe_status_t
fe_transmit_mode_t
fe_type_t
flow_compare_t
fl_owner_t
fmode_t
__force
fpregset_t
fpxregset_t
__fs16
fsid_t
gate_desc
gfn_t
gfp_t
gid16_t
gid_t
gpa_t
grant_handle_t
grant_ref_t
grant_status_t
gregset_t
greg_t
gro_result_t
gtod_long_t
gva_t
hda_nid_t
hdsp_9632_aeb_t
hdsp_config_info_t
hdsp_firmware_t
HDSP_IO_Type
hdspm_config_info_t
hdsp_mixer_t
hdspm_mixer_t
hdspm_peak_rms_t
hdspm_version_t
hdsp_peak_rms_t
hdsp_version_t
Heartbeat_type
hfn_t
hil_mlc
hil_packet
hpa_t
hugepd_t
hva_t
hwif_chipset_t
ib_sa_comp_mask
ide_drive_t
if_mask
ihandle
ino_t
insn_attr_t
insn_byte_t
insn_value_t
INT16
int16_t
int32
INT32
int32_t
int64_t
int8_t
intc_enum
__iomem
ipmi_smi_t
ipmi_user_t
ip_set_id_t
irda_queue_t
irq_hw_number_t
irqreturn_t
isolate_mode_t
itt_t
jump_label_t
__kernel_caddr_t
__kernel_clockid_t
__kernel_clock_t
__kernel_daddr_t
__kernel_dev_t
__kernel_gid16_t
__kernel_gid32_t
__kernel_gid_t
__kernel_ino_t
__kernel_ipc_pid_t
__kernel_key_t
__kernel_loff_t
__kernel_long_t
__kernel_mode_t
__kernel_mqd_t
__kernel_off_t
__kernel_old_dev_t
__kernel_old_gid_t
__kernel_old_uid_t
__kernel_pid_t
__kernel_ptrdiff_t
__kernel_sa_family_t
__kernel_size_t
__kernel_ssize_t
__kernel_suseconds_t
__kernel_timer_t
__kernel_time_t
__kernel_uid16_t
__kernel_uid32_t
__kernel_uid_t
__kernel_ulong_t
kernel_ulong_t
key_perm_t
key_ref_t
key_serial_t
key_t
kimage_entry_t
kprobe_opcode_t
ktime_t
kvm_pfn_t
ldt_desc
__le16
__le32
__le64
LOCAL_FLOW
loff_t
magic_t
mbox_msg_t
mifi_t
mmc_pm_flag_t
mode_t
MPI
mpi_limb_signed_t
mpi_limb_t
mqd_t
msi_alloc_info_t
mtd_info_t
mtrr_type
nand_ecclayout_t
nand_oobinfo_t
netdev_features_t
netdev_tx_t
nfs4_stateid
nfs4_verifier
nlink_t
nlm_args
nodemask_t
npfreg_t
npireg_t
off_t
old_gid_t
old_sigset_t
old_uid_t
omap_mbox_irq_t
OM_uint32
osd_cdb_offset
osd_id
p4d_t
p4dval_t
packed_ulong
pci_bus_addr_t
pci_bus_flags_t
pci_channel_state_t
pci_dev_flags_t
pcie_reset_state_t
pci_ers_result_t
pci_power_t
pcx_time_t
pgd_t
pgdval_t
pgoff_t
pgprot_t
pgprotval_t
pgtable_t
phandle
phys_addr_t
phys_cpuid_t
physid_mask_t
pid_t
pmd_t
pmdval_t
__portpair
projid_t
prpsinfo_t
prstatus_t
psched_tdiff_t
psched_time_t
pte_t
pteval_t
ptrdiff_t
pud_t
pudval_t
pwm_omap_dmtimer
qnx4_ftype_t
qnx4_mgid_t
qnx4_mode_t
qnx4_muid_t
qnx4_nlink_t
qnx4_nxtnt_t
qnx4_off_t
rds_rdma_cookie_t
region_info_t
region_t
req_flags_t
resource_size_t
RING_IDX
rpc_authflavor_t
rpc_fraghdr
rx_handler_result_t
s16
__s16
s32
__s32
s64
__s64
s8
__s8
sa_family_t
sata_ioreg_t
scif_epd_t
scif_pinned_pages_t
scrnmap_t
sctp_assoc_t
sctp_dup_tsn_t
sctp_initack_chunk_t
Sector
sector_t
sense_reason_t
seqcount_t
Sg_io_hdr
Sg_io_vec
Sg_req_info
Sg_scsi_id
sid_t
__sighandler_t
__sigrestore_t
sigset_t
size_t
skb_frag_t
sk_buff_data_t
snd_ctl_elem_iface_t
snd_ctl_elem_type_t
snd_hdspm_channelfader_t
snd_pcm_access_t
snd_pcm_format_t
snd_pcm_hw_param_t
snd_pcm_sframes_t
snd_pcm_state_t
snd_pcm_subformat_t
snd_pcm_uframes_t
snd_seq_client_type_t
snd_seq_event_type_t
snd_seq_real_time_t
snd_seq_timestamp_t
snd_wavefront_card_t
snd_wavefront_midi_t
snd_wavefront_mpu_id
snd_wavefront_t
speed_t
spinlock_t
sse128_t
ssize_t
status_type_t
__sum16
suseconds_t
suspend_state_t
sysv_ino_t
sysv_zone_t
task_ioreg_t
tcflag_t
__ticketpair_t
__ticket_t
time64_t
timer_t
time_t
timeu64_t
tss_desc
u16
__u16
u32
__u32
u64
__u64
u8
__u8
uch
u_char
UCHAR8
ucs2_char_t
UHWtype
uid16_t
uid_t
uint
u_int
UINT16
u_int16_t
uint16_t
UINT32
u_int32_t
uint32_t
u_int64_t
uint64_t
u_int8_t
uint8_t
uintptr_t
ulg
ulong
u_long
umode_t
unchar
unicode_t
upf_t
uprobe_opcode_t
upstat_t
u_quad_t
__user
ush
ushort
u_short
uuid_be
uuid_le
v4l2_std_id
va_list
vcpu_hvm_context_t
vgid_t
video_attributes_t
vifi_t
__virtio16
__virtio32
__virtio64
virtio_net_ctrl_ack
vmac_t
vm_flags_t
voidp
vuid_t
wait_queue_entry_t
wait_queue_head_t
wavefront_envelope
wavefront_layer
wavefront_lfo
wavefront_patch
wavefront_program
wchar_t
__wsum
xen_callback_t
XENCONS_RING_IDX
xen_hvm_pagetable_dying_t
xen_long_t
xen_pfn_t
XENSTORE_RING_IDX
xen_ulong_t
zorro_id
z_streamp
"

PARAM="-npro -kr -i8 -ts8 -sob -l80 -ss -ncs -cp1"

for t in $TYPES; do
  PARAM="$PARAM -T $t"
done

RES=`indent --version | cut -d' ' -f3`
if [ "$RES" = "" ]; then
	exit 1
fi
V1=`echo $RES | cut -d'.' -f1`
V2=`echo $RES | cut -d'.' -f2`
V3=`echo $RES | cut -d'.' -f3`

if [ $V1 -gt 2 ]; then
  PARAM="$PARAM -il0"
elif [ $V1 -eq 2 ]; then
  if [ $V2 -gt 2 ]; then
    PARAM="$PARAM -il0"
  elif [ $V2 -eq 2 ]; then
    if [ $V3 -ge 10 ]; then
      PARAM="$PARAM -il0"
    fi
  fi
fi

indent $PARAM "$@"